const YamdutMap = (() => {
    let map = null;
    let role = "passenger";
    let markers = {};
    let routeSource = null;
    let routeLayer = null;

    function log(msg) {
        console.log('[YamdutMap] ' + msg);
        if (window.java && window.java.logDebug) {
            window.java.logDebug(msg);
        }
    }

    function init(userRole) {
        role = userRole;
        log('Initializing Mapbox GL map with role: ' + role);
        
        if (map) {
            log('Map already exists, resizing...');
            map.resize();
            return true;
        }

        try {
            // Get token from MapboxConfig (passed from Java)
            const token = window.MAPBOX_TOKEN || '';
            if (!token) {
                log('ERROR: MAPBOX_TOKEN not set!');
                throw new Error('MAPBOX_TOKEN environment variable is not set. Set it in .env file.');
            }

            // Initialize Mapbox
            mapboxgl.accessToken = token;
            
            log('Creating Mapbox GL map instance');
            
            // Kathmandu bounds
            const kathmanduBounds = [
                [85.20, 27.60],
                [85.45, 27.80]
            ];
            
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [85.3240, 27.7172],
                zoom: 14,
                maxBounds: kathmanduBounds,
                pitch: 0,
                bearing: 0,
                antialias: true
            });

            // Add navigation controls
            map.addControl(new mapboxgl.NavigationControl(), 'top-right');
            
            // Add geolocate control
            map.addControl(new mapboxgl.GeolocateControl({
                positionOptions: {
                    enableHighAccuracy: true
                },
                trackUserLocation: true,
                showUserHeading: true
            }), 'top-right');

            // Show coordinates and zoom on map move
            map.on('move', function() {
                const center = map.getCenter();
                const zoom = map.getZoom();
                const coordsEl = document.getElementById('coords');
                const zoomEl = document.getElementById('zoom');
                if (coordsEl) coordsEl.textContent = center.lat.toFixed(4) + ', ' + center.lng.toFixed(4);
                if (zoomEl) zoomEl.textContent = zoom.toFixed(1);
            });

            // Handle map click
            map.on('click', function(e) {
                const lat = e.lngLat.lat;
                const lng = e.lngLat.lng;
                log('Map clicked: ' + lat.toFixed(6) + ', ' + lng.toFixed(6));
                
                if (window.java && window.java.recieveMapClick) {
                    window.java.recieveMapClick(lat, lng);
                }
            });

            // Map ready
            map.on('load', function() {
                log('Mapbox GL map loaded successfully');
                
                // Add sources for route rendering
                if (!map.getSource('route-source')) {
                    map.addSource('route-source', {
                        'type': 'geojson',
                        'data': {
                            'type': 'FeatureCollection',
                            'features': []
                        }
                    });
                }

                // Add route layer
                if (!map.getLayer('route-layer')) {
                    map.addLayer({
                        'id': 'route-layer',
                        'type': 'line',
                        'source': 'route-source',
                        'layout': {
                            'line-join': 'round',
                            'line-cap': 'round'
                        },
                        'paint': {
                            'line-color': '#2196F3',
                            'line-width': 5,
                            'line-opacity': 0.8
                        }
                    });
                }

                routeSource = map.getSource('route-source');
                routeLayer = map.getLayer('route-layer');
                
                log('Route source and layer initialized');
            });

            // Handle map errors
            map.on('error', function(e) {
                log('Mapbox error: ' + e.error.message);
            });

            log('Map initialization complete');
        } catch(err) {
            log('ERROR in init: ' + err.message);
            throw err;
        }
        map.flyTo({
            center: [lon, lat],
            zoom: zoom || 14,
            duration: 1500
        });
        log('Center set to: ' + lat + ',' + lon + ' zoom: ' + (zoom || 14));
    }

    function addOrUpdateMarker(id, lat, lon, type, label) {
        if (!map) {
            log('Cannot add marker - map not initialized');
            return;
        }
        
        if (markers[id]) {
            // Update existing marker position
            markers[id].setLngLat([lon, lat]);
            if (label) {
                markers[id].getPopup().setHTML(label);
            }
            return;
        }

        // Determine marker type and color
        let markerClass = 'marker-passenger';
        let color = '#2196F3';
        
        if (type === 'driver') {
            markerClass = 'marker-driver';
            color = '#4CAF50';
        } else if (type === 'pickup') {
            markerClass = 'marker-pickup';
            color = '#FF9800';
        } else if (type === 'dropoff') {
            markerClass = 'marker-dropoff';
            color = '#F44336';
        }

        // Create element for the marker
        const el = document.createElement('div');
        el.className = markerClass;
        el.id = 'marker-' + id;

        // Create popup
        const popup = new mapboxgl.Popup({ offset: 25 })
            .setHTML(label || id);

        // Create marker
        const marker = new mapboxgl.Marker(el)
            .setLngLat([lon, lat])
            .setPopup(popup)
            .addTo(map);

        markers[id] = marker;
        log('Marker added: ' + id + ' (' + type + ')');
    }

    function showEntities(entities) {
        if (!map) {
            log('Cannot show entities - map not initialized');
            return;
        }
        
        // Clear existing markers
        Object.values(markers).forEach(m => {
            m.remove();
        });
        markers = {};
        
        // Parse entities
        let entitiesArray = entities;
        if (typeof entities === 'string') {
            try {
                entitiesArray = JSON.parse(entities);
            } catch (e) {
                log('Error parsing entities: ' + e.message);
                return;
            }
        }

        if (!Array.isArray(entitiesArray)) {
            log('Entities is not an array');
            return;
        }

        // Add markers for each entity
        entitiesArray.forEach(e => {
            // Don't show own type
            if ((role === "driver" && e.type === "driver") || 
                (role === "passenger" && e.type === "passenger")) {
                return;
            }
            
            const label = `<strong>${e.name || e.id}</strong><br/><small>${e.type}</small>`;
            addOrUpdateMarker(e.id, e.lat, e.lon, e.type, label);
        });

        log('Showed ' + entitiesArray.length + ' entities');
    }

    function updateEntityPosition(id, lat, lon) {
        if (markers[id]) {
            markers[id].setLngLat([lon, lat]);
        } else {
            log('Marker not found for update: ' + id);
        }
    }

    async function setRoute(start, end) {
        if (!map || !routeSource) {
            log('Cannot set route - map not initialized');
            return;
        }

        clearRoute();

        try {
            // Use OSRM for routing (free, open-source)
            const url = 'https://router.project-osrm.org/route/v1/driving/' +
                start[1] + ',' + start[0] + ';' + end[1] + ',' + end[0] + 
                '?overview=full&geometries=geojson';

            log('Fetching route from OSRM');
            const res = await fetch(url);

            if (!res.ok) {
                throw new Error('Route API error: ' + res.status);
            }

            const data = await res.json();

            if (!data.routes || !data.routes.length) {
                log('No route found');
                return;
            }

            // Extract route coordinates (swap lat/lon to lng/lat for GeoJSON)
            const coords = data.routes[0].geometry.coordinates;
            
            // Update route source with GeoJSON
            routeSource.setData({
                'type': 'Feature',
                'properties': {},
                'geometry': {
                    'type': 'LineString',
                    'coordinates': coords
                }
            });

            // Fit map to route bounds
            const bounds = new mapboxgl.LngLatBounds(
                coords[0],
                coords[0]
            );
            
            coords.forEach(coord => {
                bounds.extend(coord);
            });

            map.fitBounds(bounds, {
                padding: 50,
                duration: 1000
            });

            log('Route displayed successfully');
        } catch(e) {
            log('Route error: ' + e.message);
        }
    }

    function clearRoute() {
        if (routeSource) {
            routeSource.setData({
                'type': 'FeatureCollection',
                'features': []
            });
        }
    }

    function clearMap() {
        Object.values(markers).forEach(m => {
            m.remove();
        });
        markers = {};
        clearRoute();
    }

    function resize() {
        if (map) {
            try {
                map.resize();
                log('Map resized');
            } catch (e) {
                log('Resize error: ' + e.message);
            }
        } else {
            log('Cannot resize - map not initialized');
        }
    }

    // Style utilities for switching map styles
    function setStyle(styleUrl) {
        if (map) {
            map.setStyle(styleUrl);
            log('Map style changed to: ' + styleUrl);
        }
    }

    // Expose public API
    return {
        init: init,
        setCenter: setCenter,
        addOrUpdateMarker: addOrUpdateMarker,
        showEntities: showEntities,
        updateEntityPosition: updateEntityPosition,
        setRoute: setRoute,
        clearRoute: clearRoute,
        clearMap: clearMap,
        resize: resize,
        setStyle: setStyle,
        getMap: () => map,
        getRole: () => role
    };
})();
